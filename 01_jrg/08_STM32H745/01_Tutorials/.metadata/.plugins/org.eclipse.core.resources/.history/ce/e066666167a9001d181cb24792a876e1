/*
 * CAN_RX.c
 *
 *  Created on: Feb 10, 2023
 *      Author: Yoshi
 */

#include "can_conf.h"

FDCAN_Rx_Frame_t FDCAN1_RX_bank[FDCAN_RX_MSG];



//Signals Received

CAN_data_t SoC_HV;
CAN_data_t SoC_LV;

void FDCAN_RX_Def()
{
	SoC_HV.CAN_length = RX_LENGTH8;
	SoC_HV.CAN_length_dec = 8;
	SoC_HV.CAN_id = 0x10;
	SoC_HV.CAN_startbit = 0;
	SoC_HV.Endianness = Motorola;

	SoC_LV.CAN_length = RX_LENGTH8;
	SoC_LV.CAN_length_dec = 8;
	SoC_LV.CAN_id = 0x10;
	SoC_LV.CAN_startbit = 8;
	SoC_LV.Endianness = Motorola;
}

void HAL_FDCAN_RxFifo0Callback(FDCAN_HandleTypeDef *hfdcan, uint32_t RxFifo0ITs)
{
	if((RxFifo0ITs & FDCAN_IT_RX_FIFO0_NEW_MESSAGE) != RESET)
	{
		FDCAN_Rx_Frame_t RX_BUFF;
		uint8_t RxBuff[8]= {0,0,0,0,0,0,0,0};
		CAN_RxHeaderTypeDef RxHeaderTemp = {0};

		//Retrieve Rx messages from RX FIFO0
		if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_FIFO0, &RxHeaderTemp, RX_BUFF.Data) != HAL_OK)
		{
			//Reception Error
			Error_Handler();
		}

		RX_BUFF.RxHeader = RxHeaderTemp;

		if(HAL_FDCAN_ActivateNotification(&hfdcan1, FDCAN_IT_RX_FIFO0_NEW_MESSAGE, 0) != HAL_OK)
		{
			Error_Handler();
		}

		osMessageQueuePut(CAN1_RX_Q,&RX_BUFF,1,0);
	}
}


//void HAL_FDCAN_RxBufferNewMessageCallback(FDCAN_HandleTypeDef *hfdcan)
//{
//
//
//
//	if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_BUFFER0, &RxHeaderTemp, RxData0x10) != HAL_OK)
//	{
//		//Reception Error
//		Error_Handler();
//	}
//	else if (HAL_FDCAN_GetRxMessage(hfdcan, FDCAN_RX_BUFFER1, &RxHeader, RxData0x11) != HAL_OK)
//	{
//		//Reception Error
//		Error_Handler();
//	}
//
//	for (int i = 0; i < FDCAN_RX_MSG; ++i) {
//
//		if(HAL_FDCAN_ActivateNotification(&hfdcan1, FDCAN_IT_RX_BUFFER_NEW_MESSAGE, i) != HAL_OK)
//		{
//			Error_Handler();
//		}
//	}
}

